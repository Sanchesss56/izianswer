<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
            font-family: Arial, sans-serif;
            color: white;
        }
        #gameCanvas {
            display: block;
            background-color: #222;
            margin: 10px auto;
            max-width: 100%;
            max-height: calc(100vh - 260px);
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .hidden {
            display: none !important;
        }
        .controls {
            text-align: center;
            margin: 10px auto;
            width: 100%;
            max-width: 800px;
        }
        .player-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            width: 100%;
            flex-wrap: wrap;
        }
        .player {
            padding: 8px;
            border-radius: 5px;
            width: 45%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        #player1-info {
            background-color: rgba(255, 0, 0, 0.3);
        }
        #player2-info {
            background-color: rgba(0, 0, 255, 0.3);
        }
        .health-bar {
            height: 20px;
            background-color: #555;
            margin-top: 5px;
            border-radius: 3px;
        }
        .health {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        #health1 {
            background-color: red;
            width: 100%;
        }
        #health2 {
            background-color: blue;
            width: 100%;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: none;
            width: 250px;
            font-size: 16px;
        }
        .connection-info {
            margin: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            text-align: center;
        }
        #connectionId {
            font-weight: bold;
            color: #4CAF50;
            word-break: break-all;
            padding: 5px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin-top: 10px;
            display: inline-block;
        }
        .waiting {
            background-color: #FFA500;
        }
        .connected {
            background-color: #4CAF50;
        }
        .error {
            background-color: #FF0000;
        }
        /* –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .mobile-controls {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 10px auto;
        }
        .mobile-controls-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }
        .mobile-button {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px;
            font-size: 20px;
            user-select: none;
            -webkit-user-select: none;
        }
        .mobile-button.shoot {
            width: 100px;
            background-color: rgba(255, 0, 0, 0.3);
        }
        .mobile-button:active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .mobile-button.shoot:active {
            background-color: rgba(255, 0, 0, 0.5);
        }
        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
                margin: 10px 0;
            }
            .mobile-controls {
                display: block;
            }
            button {
                font-size: 14px;
                padding: 8px 15px;
            }
            .player {
                width: 100%;
                margin: 5px 0;
            }
            .connection-info {
                margin: 10px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
    <div id="gameScreen" class="hidden">
        <div class="controls">
            <h1>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</h1>
            <div class="player-info">
                <div class="player" id="player1-info">
                    <strong id="player1-label">–•–æ—Å—Ç (–ö—Ä–∞—Å–Ω—ã–π)</strong>
                    <p id="player1-controls">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: W, A, S, D<br>–°—Ç—Ä–µ–ª—å–±–∞: Space</p>
                    <div class="health-bar">
                        <div class="health" id="health1"></div>
                    </div>
                </div>
                <div class="player" id="player2-info">
                    <strong id="player2-label">–ì–æ—Å—Ç—å (–°–∏–Ω–∏–π)</strong>
                    <p id="player2-controls">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –°—Ç—Ä–µ–ª–∫–∏<br>–°—Ç—Ä–µ–ª—å–±–∞: Enter</p>
                    <div class="health-bar">
                        <div class="health" id="health2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        
        <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="mobile-controls">
            <div class="mobile-controls-row">
                <div class="mobile-button" id="upButton">‚¨ÜÔ∏è</div>
            </div>
            <div class="mobile-controls-row">
                <div class="mobile-button" id="leftButton">‚¨ÖÔ∏è</div>
                <div class="mobile-button" id="downButton">‚¨áÔ∏è</div>
                <div class="mobile-button" id="rightButton">‚û°Ô∏è</div>
                <div class="mobile-button shoot" id="shootButton">üî´</div>
            </div>
        </div>
    </div>

    <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="startScreen" class="screen">
        <h1>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã:</p>
        <button id="localBtn">–õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ (–Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)</button>
        <button id="createGameBtn">–°–æ–∑–¥–∞—Ç—å –æ–Ω–ª–∞–π–Ω –∏–≥—Ä—É</button>
        <button id="joinGameBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã -->
    <div id="createGameScreen" class="screen hidden">
        <h1>–°–æ–∑–¥–∞–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –∏–≥—Ä—ã</h1>
        <div class="connection-info">
            <p>–í–∞—à ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</p>
            <p id="connectionId">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...</p>
            <div id="connectionStatus" class="status waiting">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞...</div>
        </div>
        <button id="backFromCreateBtn">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–≥—Ä–µ -->
    <div id="joinGameScreen" class="screen hidden">
        <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã, –∫ –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:</p>
        <input type="text" id="gameIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã">
        <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <div id="joinStatus" class="status hidden"></div>
        <button id="backFromJoinBtn">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã -->
    <div id="gameOverScreen" class="screen hidden">
        <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h1>
        <h2 id="winner">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: </h2>
        <button id="restartBtn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        <button id="mainMenuBtn">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>

    <script>
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const startScreen = document.getElementById('startScreen');
        const createGameScreen = document.getElementById('createGameScreen');
        const joinGameScreen = document.getElementById('joinGameScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const connectionId = document.getElementById('connectionId');
        const gameIdInput = document.getElementById('gameIdInput');
        const connectionStatus = document.getElementById('connectionStatus');
        const joinStatus = document.getElementById('joinStatus');
        const player1Label = document.getElementById('player1-label');
        const player2Label = document.getElementById('player2-label');
        const player1Controls = document.getElementById('player1-controls');
        const player2Controls = document.getElementById('player2-controls');

        // –ö–Ω–æ–ø–∫–∏
        const localBtn = document.getElementById('localBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const connectBtn = document.getElementById('connectBtn');
        const backFromCreateBtn = document.getElementById('backFromCreateBtn');
        const backFromJoinBtn = document.getElementById('backFromJoinBtn');
        const restartBtn = document.getElementById('restartBtn');
        const mainMenuBtn = document.getElementById('mainMenuBtn');
        
        // –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const upButton = document.getElementById('upButton');
        const downButton = document.getElementById('downButton');
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const shootButton = document.getElementById('shootButton');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ canvas –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        function resizeCanvas() {
            const gameCanvas = document.getElementById('gameCanvas');
            const maxWidth = Math.min(window.innerWidth - 30, 800);
            const aspectRatio = 16 / 10;
            const calculatedHeight = maxWidth / aspectRatio;
            
            gameCanvas.style.width = maxWidth + 'px';
            gameCanvas.style.height = calculatedHeight + 'px';
        }

        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const mobileKeyState = {
            up: false,
            down: false,
            left: false,
            right: false,
            shoot: false
        };
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
        function setupMobileControls() {
            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            function handleTouchStart(key, event) {
                event.preventDefault();
                mobileKeyState[key] = true;
            }
            
            function handleTouchEnd(key, event) {
                event.preventDefault();
                mobileKeyState[key] = false;
            }
            
            // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏
            upButton.addEventListener('touchstart', (e) => handleTouchStart('up', e));
            upButton.addEventListener('touchend', (e) => handleTouchEnd('up', e));
            
            downButton.addEventListener('touchstart', (e) => handleTouchStart('down', e));
            downButton.addEventListener('touchend', (e) => handleTouchEnd('down', e));
            
            leftButton.addEventListener('touchstart', (e) => handleTouchStart('left', e));
            leftButton.addEventListener('touchend', (e) => handleTouchEnd('left', e));
            
            rightButton.addEventListener('touchstart', (e) => handleTouchStart('right', e));
            rightButton.addEventListener('touchend', (e) => handleTouchEnd('right', e));
            
            shootButton.addEventListener('touchstart', (e) => handleTouchStart('shoot', e));
            shootButton.addEventListener('touchend', (e) => handleTouchEnd('shoot', e));
            
            // –î–ª—è –º—ã—à–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            upButton.addEventListener('mousedown', () => mobileKeyState.up = true);
            upButton.addEventListener('mouseup', () => mobileKeyState.up = false);
            
            downButton.addEventListener('mousedown', () => mobileKeyState.down = true);
            downButton.addEventListener('mouseup', () => mobileKeyState.down = false);
            
            leftButton.addEventListener('mousedown', () => mobileKeyState.left = true);
            leftButton.addEventListener('mouseup', () => mobileKeyState.left = false);
            
            rightButton.addEventListener('mousedown', () => mobileKeyState.right = true);
            rightButton.addEventListener('mouseup', () => mobileKeyState.right = false);
            
            shootButton.addEventListener('mousedown', () => mobileKeyState.shoot = true);
            shootButton.addEventListener('mouseup', () => mobileKeyState.shoot = false);
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (isMobile) {
            setupMobileControls();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            player1Controls.innerHTML = "–°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
            player2Controls.innerHTML = "–°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
        }

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç canvas –∏ –µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã
        let gameMode = ''; // 'local', 'host', 'client'
        let isGameRunning = false;
        let peer = null;
        let conn = null;
        let playerRole = ''; // 'host' –∏–ª–∏ 'client'
        let lastSyncTime = 0;
        const syncInterval = 50; // –ú–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è–º–∏ (20 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)

        // –ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–æ–≤
        let player1Health = 100;
        let player2Health = 100;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä–æ–∫–æ–≤
        const player1 = {
            x: 100,
            y: canvas.height / 2,
            width: 40,
            height: 40,
            color: 'red',
            speed: 5,
            bullets: [],
            lastShot: 0,
            cooldown: 500 // –º–∏–ª–∏—Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –≤—ã—Å—Ç—Ä–µ–ª–∞–º–∏
        };

        const player2 = {
            x: canvas.width - 100,
            y: canvas.height / 2,
            width: 40,
            height: 40,
            color: 'blue',
            speed: 5,
            bullets: [],
            lastShot: 0,
            cooldown: 500
        };

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É–ª—å
        const bulletSpeed = 7;
        const bulletSize = 10;
        const bulletDamage = 10;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const keys = {};

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
        window.addEventListener('keydown', function(e) {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', function(e) {
            keys[e.key] = false;
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        localBtn.addEventListener('click', startLocalGame);
        createGameBtn.addEventListener('click', showCreateGameScreen);
        joinGameBtn.addEventListener('click', showJoinGameScreen);
        connectBtn.addEventListener('click', joinGame);
        backFromCreateBtn.addEventListener('click', backToMainMenu);
        backFromJoinBtn.addEventListener('click', backToMainMenu);
        restartBtn.addEventListener('click', restartGame);
        mainMenuBtn.addEventListener('click', backToMainMenu);

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screen) {
            startScreen.classList.add('hidden');
            createGameScreen.classList.add('hidden');
            joinGameScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            
            screen.classList.remove('hidden');
        }

        function startLocalGame() {
            gameMode = 'local';
            playerRole = 'host';
            player1Label.textContent = "–ò–≥—Ä–æ–∫ 1 (–ö—Ä–∞—Å–Ω—ã–π)";
            player2Label.textContent = "–ò–≥—Ä–æ–∫ 2 (–°–∏–Ω–∏–π)";
            showScreen(gameScreen);
            resetGame();
        }

        function showCreateGameScreen() {
            showScreen(createGameScreen);
            initPeer();
        }

        function showJoinGameScreen() {
            showScreen(joinGameScreen);
            joinStatus.classList.add('hidden');
        }

        function backToMainMenu() {
            if (peer) {
                peer.destroy();
                peer = null;
            }
            if (conn) {
                conn.close();
                conn = null;
            }
            
            isGameRunning = false;
            showScreen(startScreen);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function initPeer() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
            const peerId = 'game-' + Math.floor(Math.random() * 100000);
            
            peer = new Peer(peerId);
            
            peer.on('open', (id) => {
                connectionId.textContent = id;
            });
            
            peer.on('connection', (connection) => {
                conn = connection;
                
                conn.on('open', () => {
                    connectionStatus.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!';
                    connectionStatus.classList.remove('waiting');
                    connectionStatus.classList.add('connected');
                    
                    setTimeout(() => {
                        gameMode = 'host';
                        playerRole = 'host';
                        player1Label.textContent = "–í—ã (–•–æ—Å—Ç - –ö—Ä–∞—Å–Ω—ã–π)";
                        player2Label.textContent = "–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ (–ì–æ—Å—Ç—å - –°–∏–Ω–∏–π)";
                        showScreen(gameScreen);
                        resetGame();
                    }, 1000);
                });
                
                setupConnectionHandlers();
            });
            
            peer.on('error', (err) => {
                console.error(err);
                connectionStatus.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
                connectionStatus.classList.remove('waiting');
                connectionStatus.classList.add('error');
            });
        }

        function joinGame() {
            const gameId = gameIdInput.value.trim();
            
            if (!gameId) {
                joinStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã';
                joinStatus.classList.remove('hidden');
                joinStatus.classList.add('error');
                return;
            }
            
            joinStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            joinStatus.classList.remove('hidden', 'error');
            joinStatus.classList.add('waiting');
            
            peer = new Peer();
            
            peer.on('open', () => {
                conn = peer.connect(gameId);
                
                conn.on('open', () => {
                    joinStatus.textContent = '–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!';
                    joinStatus.classList.remove('waiting', 'error');
                    joinStatus.classList.add('connected');
                    
                    setupConnectionHandlers();
                    
                    setTimeout(() => {
                        gameMode = 'client';
                        playerRole = 'client';
                        player1Label.textContent = "–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ (–•–æ—Å—Ç - –ö—Ä–∞—Å–Ω—ã–π)";
                        player2Label.textContent = "–í—ã (–ì–æ—Å—Ç—å - –°–∏–Ω–∏–π)";
                        showScreen(gameScreen);
                        resetGame();
                    }, 1000);
                });
                
                conn.on('error', (err) => {
                    console.error(err);
                    joinStatus.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + err.message;
                    joinStatus.classList.remove('waiting');
                    joinStatus.classList.add('error');
                });
            });
            
            peer.on('error', (err) => {
                console.error(err);
                joinStatus.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
                joinStatus.classList.remove('waiting');
                joinStatus.classList.add('error');
            });
        }

        function setupConnectionHandlers() {
            conn.on('data', (data) => {
                if (data.type === 'gameState') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                    player1.x = data.player1.x;
                    player1.y = data.player1.y;
                    player1.bullets = data.player1.bullets;
                    
                    player2.x = data.player2.x;
                    player2.y = data.player2.y;
                    player2.bullets = data.player2.bullets;
                    
                    player1Health = data.player1Health;
                    player2Health = data.player2Health;
                    
                    updateHealthBars();
                } else if (data.type === 'gameOver') {
                    endGame(data.winner, data.reason);
                } else if (data.type === 'restart') {
                    resetGame();
                }
            });
            
            conn.on('close', () => {
                if (isGameRunning) {
                    if (playerRole === 'host') {
                        endGame('–•–æ—Å—Ç (–ö—Ä–∞—Å–Ω—ã–π)', '–ì–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                    } else {
                        endGame('–ì–æ—Å—Ç—å (–°–∏–Ω–∏–π)', '–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                    }
                }
            });
        }

        function sendGameState() {
            if (conn && conn.open && Date.now() - lastSyncTime > syncInterval) {
                conn.send({
                    type: 'gameState',
                    player1: {
                        x: player1.x,
                        y: player1.y,
                        bullets: player1.bullets
                    },
                    player2: {
                        x: player2.x,
                        y: player2.y,
                        bullets: player2.bullets
                    },
                    player1Health: player1Health,
                    player2Health: player2Health
                });
                
                lastSyncTime = Date.now();
            }
        }

        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function restartGame() {
            resetGame();
            
            if (gameMode !== 'local' && conn && conn.open) {
                conn.send({
                    type: 'restart'
                });
            }
        }

        function resetGame() {
            player1Health = 100;
            player2Health = 100;
            
            player1.x = 100;
            player1.y = canvas.height / 2;
            player1.bullets = [];
            
            player2.x = canvas.width - 100;
            player2.y = canvas.height / 2;
            player2.bullets = [];
            
            updateHealthBars();
            showScreen(gameScreen);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            if (!isGameRunning) {
                isGameRunning = true;
                gameLoop();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ
        function updateHealthBars() {
            document.getElementById('health1').style.width = player1Health + '%';
            document.getElementById('health2').style.width = player2Health + '%';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function checkMobileControls() {
            if (mobileKeyState.up) keys['ArrowUp'] = true;
            else keys['ArrowUp'] = false;
            
            if (mobileKeyState.down) keys['ArrowDown'] = true;
            else keys['ArrowDown'] = false;
            
            if (mobileKeyState.left) keys['ArrowLeft'] = true;
            else keys['ArrowLeft'] = false;
            
            if (mobileKeyState.right) keys['ArrowRight'] = true;
            else keys['ArrowRight'] = false;
            
            if (mobileKeyState.shoot) keys['Enter'] = true;
            else keys['Enter'] = false;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞–º–∏
        function movePlayer1() {
            // –•–æ—Å—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç player1, –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
            if (gameMode === 'local' || (gameMode === 'host' && playerRole === 'host')) {
                let moved = false;
                
                if (keys['w'] || keys['W']) {
                    player1.y -= player1.speed;
                    moved = true;
                }
                if (keys['s'] || keys['S']) {
                    player1.y += player1.speed;
                    moved = true;
                }
                if (keys['a'] || keys['A']) {
                    player1.x -= player1.speed;
                    moved = true;
                }
                if (keys['d'] || keys['D']) {
                    player1.x += player1.speed;
                    moved = true;
                }

                // –°—Ç—Ä–µ–ª—å–±–∞
                if ((keys[' '] || keys['Spacebar']) && Date.now() - player1.lastShot > player1.cooldown) {
                    player1.bullets.push({
                        x: player1.x + player1.width,
                        y: player1.y + player1.height / 2,
                        radius: bulletSize / 2,
                        color: player1.color
                    });
                    player1.lastShot = Date.now();
                    moved = true;
                }

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ö–æ–ª—Å—Ç–∞
                player1.x = Math.max(0, Math.min(canvas.width - player1.width, player1.x));
                player1.y = Math.max(0, Math.min(canvas.height - player1.height, player1.y));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                if (moved && gameMode !== 'local') {
                    sendGameState();
                }
            }
        }

        function movePlayer2() {
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (isMobile) {
                checkMobileControls();
            }
            
            // –ö–ª–∏–µ–Ω—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç player2, —Ö–æ—Å—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
            if (gameMode === 'local' || (gameMode === 'client' && playerRole === 'client')) {
                let moved = false;
                
                if (keys['ArrowUp']) {
                    player2.y -= player2.speed;
                    moved = true;
                }
                if (keys['ArrowDown']) {
                    player2.y += player2.speed;
                    moved = true;
                }
                if (keys['ArrowLeft']) {
                    player2.x -= player2.speed;
                    moved = true;
                }
                if (keys['ArrowRight']) {
                    player2.x += player2.speed;
                    moved = true;
                }

                // –°—Ç—Ä–µ–ª—å–±–∞
                if (keys['Enter'] && Date.now() - player2.lastShot > player2.cooldown) {
                    player2.bullets.push({
                        x: player2.x,
                        y: player2.y + player2.height / 2,
                        radius: bulletSize / 2,
                        color: player2.color
                    });
                    player2.lastShot = Date.now();
                    moved = true;
                }

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ö–æ–ª—Å—Ç–∞
                player2.x = Math.max(0, Math.min(canvas.width - player2.width, player2.x));
                player2.y = Math.max(0, Math.min(canvas.height - player2.height, player2.y));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                if (moved && gameMode !== 'local') {
                    sendGameState();
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø—É–ª—å
        function updateBullets() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ö–æ—Å—Ç–∞ –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–≥—Ä—ã
            if (gameMode === 'local' || playerRole === 'host') {
                // –ü—É–ª–∏ –∏–≥—Ä–æ–∫–∞ 1 –¥–≤–∏–∂—É—Ç—Å—è –≤–ø—Ä–∞–≤–æ
                for (let i = player1.bullets.length - 1; i >= 0; i--) {
                    const bullet = player1.bullets[i];
                    bullet.x += bulletSpeed;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∏–≥—Ä–æ–∫–∞ 2
                    if (bullet.x + bullet.radius > player2.x && 
                        bullet.x - bullet.radius < player2.x + player2.width &&
                        bullet.y + bullet.radius > player2.y && 
                        bullet.y - bullet.radius < player2.y + player2.height) {
                        player2Health -= bulletDamage;
                        updateHealthBars();
                        player1.bullets.splice(i, 1);
                        
                        if (gameMode !== 'local') {
                            sendGameState();
                        }
                        
                        if (player2Health <= 0) {
                        endGame(1);
                    }
                    continue;
                }

                // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–ª—å, –≤—ã—à–µ–¥—à–∏—Ö –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                if (bullet.x - bullet.radius > canvas.width) {
                    player1.bullets.splice(i, 1);
                }
            }

            // –ü—É–ª–∏ –∏–≥—Ä–æ–∫–∞ 2 –¥–≤–∏–∂—É—Ç—Å—è –≤–ª–µ–≤–æ
            for (let i = player2.bullets.length - 1; i >= 0; i--) {
                const bullet = player2.bullets[i];
                bullet.x -= bulletSpeed;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∏–≥—Ä–æ–∫–∞ 1
                if (bullet.x + bullet.radius > player1.x && 
                    bullet.x - bullet.radius < player1.x + player1.width &&
                    bullet.y + bullet.radius > player1.y && 
                    bullet.y - bullet.radius < player1.y + player1.height) {
                    player1Health -= bulletDamage;
                    updateHealthBars();
                    player2.bullets.splice(i, 1);
                    
                    if (player1Health <= 0) {
                        endGame(2);
                    }
                    continue;
                }

                // –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–ª—å, –≤—ã—à–µ–¥—à–∏—Ö –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                if (bullet.x + bullet.radius < 0) {
                    player2.bullets.splice(i, 1);
                }
            }
            
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ –ø–æ —Å–µ—Ç–∏ –∏ –º–æ–π —Ö–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            if (gameMode !== 'local' && isMyTurn && (player1.bullets.length > 0 || player2.bullets.length > 0)) {
                sendGameState();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        function endGame(winner, reason = '') {
            isGameRunning = false;
            
            const winnerText = document.getElementById('winner');
            winnerText.textContent = reason || `–ò–≥—Ä–æ–∫ ${winner} –ø–æ–±–µ–¥–∏–ª!`;
            
            showScreen(gameOverScreen);
            
            if (gameMode !== 'local' && conn && conn.open) {
                conn.send({
                    type: 'gameOver',
                    winner: winner,
                    reason: reason
                });
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞ 1
            ctx.fillStyle = player1.color;
            ctx.fillRect(player1.x, player1.y, player1.width, player1.height);

            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞ 2
            ctx.fillStyle = player2.color;
            ctx.fillRect(player2.x, player2.y, player2.width, player2.height);

            // –†–∏—Å—É–µ–º –ø—É–ª–∏ –∏–≥—Ä–æ–∫–∞ 1
            ctx.fillStyle = player1.color;
            player1.bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            // –†–∏—Å—É–µ–º –ø—É–ª–∏ –∏–≥—Ä–æ–∫–∞ 2
            ctx.fillStyle = player2.color;
            player2.bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            if (!isGameRunning) return;
            
            movePlayer1();
            movePlayer2();
            updateBullets();
            draw();
            
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
